<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investment Planning Scenarios</title>
  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f4f6f9; color: #333; line-height: 1.6; }
    /* Container */
    .container { max-width: 900px; margin: 40px auto; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
    /* Header */
    .header { background: #1e5aad; color: #fff; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
    .header .logo { font-size: 1.4rem; font-weight: bold; }
    .header .contact { font-size: 0.9rem; text-align: right; }
    /* Main Content */
    .content { padding: 30px; }
    .content h1 { font-size: 1.8rem; margin-bottom: 8px; }
    .content p { font-size: 1rem; color: #555; margin-bottom: 24px; }
    /* Controls */
    .controls { margin-bottom: 16px; display: flex; gap: 10px; }
    .btn { padding: 8px 16px; background: #1e5aad; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #154a8c; }
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { padding: 0; text-align: center; height: 44px; }
    th {
      background: #f5f7fa;
      font-weight: 600;
      color: #444;
      height: 44px;
      vertical-align: middle;
    }
    tr + tr { border-top: 1px solid #e0e0e0; }
    td input {
      width: 110px; /* fits 7 digits comfortably */
      min-width: 110px;
      max-width: 110px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      font-size: 1rem;
      box-sizing: border-box;
      display: block;
      margin: 0 auto;
    }
    td.number { color: #28a745; font-weight: bold; }
    /* Totals */
    .totals { display: flex; gap: 16px; margin-bottom: 24px; }
    .totals .box { flex: 1; background: #fafbfc; border: 1px solid #e0e0e0; border-radius: 4px; padding: 20px; text-align: center; }
    .box h3 { font-size: 1.4rem; margin-bottom: 4px; }
    .box p { font-size: 0.9rem; color: #555; }
    /* Footer */
    .footer { background: #1e5aad; color: #fff; padding: 16px 30px; font-size: 0.8rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">Bright Path Financials</div>
      <div class="contact">
        Hello@brightpathfinancials.com<br />929-675-9115
      </div>
    </header>
    <div class="content">
      <h1>Investment Planning Scenarios</h1>
      <p>Enter scenarios below, then click "Compute" to see required weekly investments.</p>

      <div class="controls">
        <button class="btn" id="addRowBtn">Add Scenario</button>
        <button class="btn" id="computeBtn">Compute</button>
        <button class="btn" id="downloadBtn">Download PDF</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 40px;"></th>
            <th style="width: 110px;"><span style="display: inline-block; width: 110px;">Goal ($)</span></th>
            <th style="width: 110px;">
              <span style="display: inline-block; width: 110px;">Starting Age</span>
            </th>
            <th style="width: 110px;"><span style="display: inline-block; width: 110px;">Ending Age</span></th>
            <th colspan="3" style="background: #f5f7fa; border-bottom: none; padding: 0;">
              <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 0.7em; width: 330px;">
                <span style="font-weight: 600; font-size: 1.05em; margin-right: 0.7em; border-right: 1px solid #ccc; padding-right: 0.7em;">Investment</span>
                <span style="font-weight: 600; color: #1e5aad;">Weekly</span>
                <span style="font-weight: 600; color: #1e5aad;">Monthly</span>
                <span style="font-weight: 600; color: #1e5aad;">Yearly</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody id="tableRows">
          <!-- Rows will be generated by JavaScript -->
        </tbody>
      </table>

      <div class="totals">
        <div class="box">
          <h3 id="weeklyTotal">$0.00</h3>
          <p>Weekly Total</p>
        </div>
        <div class="box">
          <h3 id="monthlyTotal">$0.00</h3>
          <p>Monthly Total</p>
        </div>
        <div class="box">
          <h3 id="yearlyTotal">$0.00</h3>
          <p>Yearly Total</p>
        </div>
      </div>
    </div>
    <footer class="footer">
      This is a planning estimate. Investment results may vary. Past performance does not guarantee future results.
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script>

    function createScenarioRow(goal = '', startAge = '', endAge = '', checked = true) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" ${checked ? 'checked' : ''}></td>
        <td style="position: relative;">
          <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 1rem; color: #888; pointer-events: none;">$</span>
          <input type="text" class="goal" value="${goal}" maxlength="9" style="padding-left: 22px;" inputmode="numeric" pattern="[0-9,]*">
        </td>
        <td><input type="number" class="startAge" value="${startAge}" maxlength="7"></td>
        <td><input type="number" class="endAge" value="${endAge}" maxlength="7"></td>
        <td class="number weekly">--</td>
        <td class="number monthly">--</td>
        <td class="number yearly">--</td>
      `;
      return tr;
    }

    // Add 7 empty rows on page load
    window.addEventListener('DOMContentLoaded', () => {
      const tableRows = document.getElementById('tableRows');
      for (let i = 0; i < 7; i++) {
        tableRows.appendChild(createScenarioRow('', '', '', true));
      }
    });

    document.getElementById('addRowBtn').addEventListener('click', () => {
      const tableRows = document.getElementById('tableRows');
      tableRows.appendChild(createScenarioRow('', '', '', true));
    });

    function parseGoalInput(val) {
      // Remove commas and $ sign, then parse as float
      return parseFloat(val.replace(/[$,]/g, '')) || 0;
    }

    function formatGoalInput(val) {
      // Remove non-digits, then add commas
      let num = val.replace(/[^\d]/g, '');
      if (!num) return '';
      return num.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Format goal input on input event
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('goal')) {
        let cursor = e.target.selectionStart;
        let before = e.target.value;
        let formatted = formatGoalInput(before);
        e.target.value = formatted;
        // Try to keep cursor position
        let diff = formatted.length - before.length;
        e.target.setSelectionRange(cursor + diff, cursor + diff);
      }
    });

    document.getElementById('computeBtn').addEventListener('click', () => {
      const rows = document.querySelectorAll('#tableRows tr');
      let weeklySum = 0;
      let monthlySum = 0;
      console.log('--- Compute Button Clicked ---');
      rows.forEach((row, idx) => {
        const check = row.querySelector('.row-check');
        console.log(`Row ${idx + 1}:`);
        console.log('  check:', check ? check.checked : undefined);
        if (!check || !check.checked) {
          row.querySelector('.weekly').innerText = '--';
          row.querySelector('.monthly').innerText = '--';
          row.querySelector('.yearly').innerText = '--';
          return;
        }
        const goalInput = row.querySelector('.goal');
        const goalVal = goalInput ? goalInput.value : '';
        const goal = goalInput ? parseGoalInput(goalInput.value) : 0;
        const startVal = row.querySelector('.startAge') ? row.querySelector('.startAge').value : '';
        const start = parseFloat(startVal) || 0;
        const endVal = row.querySelector('.endAge') ? row.querySelector('.endAge').value : '';
        const end = parseFloat(endVal) || 0;
        const years = end - start;
        const weeks = years * 52.1775;

        // New logic: calculate required payment per period to reach goal with compounding
        // r = annual rate, n = years, PMT = payment per period, FV = future value (goal)
        // Each payment compounds: first year 5%, then 10% for each remaining year
        // We'll solve for PMT (payment per year), then divide by 52.1775 or 12 for weekly/monthly

        function futureValueOfPayment(pmt, years) {
          let fv = 0;
          for (let y = 0; y < years; y++) {
            let value = pmt;
            // First year: 5% growth
            value *= 1.05;
            // Remaining years: 10% compounding
            for (let z = 0; z < (years - y - 1); z++) {
              value *= 1.10;
            }
            fv += value;
          }
          return fv;
        }

        let requiredAnnual = 0;
        if (years > 0) {
          // Use binary search to solve for required annual payment
          let low = 0, high = goal * 2, mid, fv;
          for (let i = 0; i < 30; i++) { // 30 iterations is plenty for convergence
            mid = (low + high) / 2;
            fv = futureValueOfPayment(mid, years);
            if (fv < goal) {
              low = mid;
            } else {
              high = mid;
            }
          }
          requiredAnnual = (low + high) / 2;
        }
        const weekly = years > 0 ? requiredAnnual / 52.1775 : 0;
        const monthly = years > 0 ? requiredAnnual / 12 : 0;
        const yearly = years > 0 ? requiredAnnual : 0;

        console.log('  goalInput.value:', goalVal);
        console.log('  goal:', goal);
        console.log('  startAge.value:', startVal);
        console.log('  start:', start);
        console.log('  endAge.value:', endVal);
        console.log('  end:', end);
        console.log('  years:', years);
        console.log('  weeks:', weeks);
        console.log('  requiredAnnual:', requiredAnnual);
        console.log('  weekly:', weekly);
        console.log('  monthly:', monthly);
        console.log('  yearly:', yearly);

        row.querySelector('.weekly').innerText = `$${weekly.toFixed(2)}`;
        row.querySelector('.monthly').innerText = `$${monthly.toFixed(2)}`;
        row.querySelector('.yearly').innerText = `$${yearly.toFixed(2)}`;
        weeklySum += weekly;
        monthlySum += monthly;
      });
      console.log('weeklySum:', weeklySum);
      console.log('monthlySum:', monthlySum);
      console.log('yearlySum:', weeklySum * 52.1775);
      document.getElementById('weeklyTotal').innerText = `$${weeklySum.toFixed(2)}`;
      document.getElementById('monthlyTotal').innerText = `$${monthlySum.toFixed(2)}`;
      document.getElementById('yearlyTotal').innerText = `$${(weeklySum * 52.1775).toFixed(2)}`;
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const element = document.querySelector('.container');
      html2pdf().set({ margin:0.5, filename:'investment_plan.pdf', html2canvas:{ scale:2 } }).from(element).save();
    });
  </script>
</body>
</html>
